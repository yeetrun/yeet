#!/usr/bin/env bash
# Copyright (c) 2025 AUTHORS All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

set -euo pipefail

repo_root=$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)
cd "$repo_root"

if ! command -v mise >/dev/null 2>&1; then
  echo "mise is required to run staticcheck with the repo toolchain." >&2
  echo "Install and run: mise install" >&2
  exit 1
fi

exec mise exec -- bash -lc '
set -euo pipefail

gobin="$(go env GOBIN)"
if [[ -z "$gobin" ]]; then
  gobin="$(go env GOPATH)/bin"
fi
staticcheck_bin="${gobin}/staticcheck"
go_version="$(go env GOVERSION)"

needs_install=true
if [[ -x "$staticcheck_bin" ]]; then
  if go version -m "$staticcheck_bin" | grep -q "$go_version"; then
    needs_install=false
  fi
fi

if [[ "$needs_install" == "true" ]]; then
  go install honnef.co/go/tools/cmd/staticcheck@latest
fi

exec "$staticcheck_bin" ./...
'
